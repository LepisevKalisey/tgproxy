# Telegram Bridge Bot

Бот для создания моста между личными сообщениями пользователей и темами форума в супергруппе Telegram.

## Функциональность

- Автоматическое создание тем в форуме для каждого пользователя
- Пересылка сообщений из ЛС в соответствующую тему форума
- Пересылка ответов из темы форума обратно в ЛС пользователю
- Поддержка всех типов контента: текст, фото, документы, аудио, видео, голосовые, стикеры
- Команды администратора: `/id`, `/rename`, `/close`
- Карточки пользователей с ограничением отправки (1 раз в день)

## Установка

### Локальная установка

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd tgproxy
```

2. Установите зависимости:
```bash
npm install
```

3. Создайте файл `.env` и заполните переменные окружения:
```env
BOT_TOKEN=your_bot_token_here
GROUP_ID=-1001234567890
ADMIN_IDS=123456789,987654321
APP_BASE_URL=https://your-domain.com
WEBHOOK_SECRET=your_webhook_secret
PORT=8080
DATA_DIR=./data
```

4. Запустите бота:
```bash
npm start
```

### Docker

1. Соберите образ:
```bash
docker build -t telegram-bridge .
```

2. Запустите контейнер:
```bash
docker run -d \
  --name telegram-bridge \
  -p 8080:8080 \
  -v $(pwd)/data:/app/data \
  --env-file .env \
  telegram-bridge
```

## Настройка

### Переменные окружения

- `BOT_TOKEN` - токен бота от @BotFather
- `GROUP_ID` - ID супергруппы с включенными темами
- `ADMIN_IDS` - ID администраторов через запятую
- `APP_BASE_URL` - базовый URL приложения для webhook
- `WEBHOOK_SECRET` - секретный токен для webhook
- `PORT` - порт для Express сервера (по умолчанию 8080)
- `DATA_DIR` - директория для хранения данных (по умолчанию ./data)

### Настройка Telegram

1. Создайте бота через @BotFather
2. Создайте супергруппу и включите темы (Topics)
3. Добавьте бота в супергруппу с правами администратора
4. Получите ID группы (можете использовать команду `/id` в группе)

## Команды

### Для пользователей
- `/start` - начать работу с ботом

### Для администраторов (только в темах форума)
- `/id` - показать информацию о пользователе темы
- `/rename <новое_имя>` - переименовать тему
- `/close` - закрыть тему (архивировать)

## API Endpoints

- `GET /healthz` - проверка здоровья приложения
- `POST /tg/webhook` - webhook для получения обновлений от Telegram

## Структура данных

Бот использует JSON файлы для хранения данных:

- `users.json` - информация о пользователях
- `threads.json` - связь между пользователями и темами форума

## Безопасность

- Валидация webhook через `X-Telegram-Bot-Api-Secret-Token`
- Запуск в Docker под непривилегированным пользователем
- Исключение логирования чувствительной информации
- Health check для мониторинга состояния

## Разработка

Для разработки используйте:
```bash
npm run dev
```

## Лицензия

MIT